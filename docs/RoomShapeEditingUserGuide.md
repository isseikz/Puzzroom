# 部屋の形状編集 - ユーザーガイド

## はじめに

このガイドでは、Puzzroomアプリで部屋の形状を作成・編集する方法を説明します。間取り図の画像をインポートし、正確な寸法で部屋の形状を定義できます。

## 基本的な流れ

### 1. 背景画像のインポート

1. 「写真選択」ボタンをタップ
2. デバイスから間取り図の画像を選択
3. 画像がキャンバスの背景に表示されます

💡 **ヒント**: 画像は間取り図の写真やスキャンが最適です。

### 2. 部屋の形状を作成

#### 作成モード

1. キャンバス上で部屋の角にあたる位置をタップして頂点を追加
2. 部屋の外周をなぞるように頂点を追加していきます
3. 最初の頂点の近く（約40ピクセル以内）をタップすると、ポリゴンが完成します

💡 **操作のしきい値**:
- ポリゴン完成: 最初の頂点から40ピクセル以内
- 頂点選択: 頂点から30ピクセル以内
- 辺選択: 辺から30ピクセル以内

![Creation Mode](./images/room-creation-mode.png)

💡 **ヒント**: 
- 最低3つの頂点が必要です
- 頂点は時計回りまたは反時計回りに追加できます
- 間違えた場合は、ポリゴンリストから削除して再作成できます

### 3. 頂点の位置を調整

#### 編集モード

1. ポリゴンリストから編集したい部屋を選択
2. 「頂点移動」ボタンをタップ
3. 頂点をドラッグして位置を調整

![Editing Mode](./images/room-editing-mode.png)

💡 **ヒント**: 
- 頂点は青い円で表示されます
- ドラッグ中は緑色に変わります
- 背景画像に合わせて微調整できます

### 4. 辺の長さを設定

#### 寸法編集モード

1. ポリゴンリストから部屋を選択
2. 「寸法編集」ボタンをタップ
3. 調整したい辺をタップ
4. ModalBottomSheetが表示されます
5. 新しい長さ（cm単位）を入力

![Dimension Editing Mode](./images/room-dimension-mode.png)

#### 相似変換モード（初回）

最初の辺の長さを設定すると、**相似変換モード**が適用されます：

- 📐 図形全体が相似となるように、すべての辺が比例して調整されます
- 画面上の形状（角度）は維持されます
- 実際の寸法が正確に反映されます

**例**: 
- 画面上で100ピクセルの辺を300cmに設定
- 他の辺も同じ比率（3倍）でスケーリングされます

#### 個別調整モード（2回目以降）

相似変換適用後、他の辺を調整すると**個別調整モード**になります：

- 📏 選択した辺のみが調整されます
- 他の辺の長さは維持されます
- 角度が自動的に調整される場合があります

#### 辺のロック

重要な辺の長さを固定するには：

1. 辺を選択
2. ModalBottomSheetで「寸法をロック」トグルをタップ
3. ロックされた辺は🔒アイコンと金色で表示されます

💡 **ヒント**: 
- ロックされた辺は変更できません
- ロックを解除するには、再度トグルをタップ
- すべての辺をロックすると、完全拘束状態になります

### 5. 角度を調整

#### 角度編集モード

1. ポリゴンリストから部屋を選択
2. 「角度編集」ボタンをタップ
3. 調整したい頂点をタップ
4. ModalBottomSheetが表示されます
5. 新しい角度（度）を入力

![Angle Editing Mode](./images/room-angle-mode.png)

#### 90度拘束

部屋の角を直角にするには：

1. 頂点を選択
2. 「90°に拘束」ボタンをタップ
3. 角度が90度に設定され、自動的にロックされます

💡 **注意**: 
- ⚠️ 角度を調整すると、ポリゴンが開く可能性があります
- ポリゴンが開いた場合、AngleEditSheetに警告カードと「自動で閉じる」ボタンが表示されます
- ボタンをタップすると、最後の頂点を削除して自動的にポリゴンを閉じます

#### 角度のロック

重要な角度を固定するには：

1. 頂点を選択
2. ModalBottomSheetで「角度をロック」トグルをタップ
3. ロックされた頂点は🔒アイコンと金色で表示されます

### 6. 拘束状態の確認

右側のサイドバーに拘束状態が表示されます：

```
拘束状態
ロック済み辺: 3 / 4
ロック済み角度: 2 / 4
```

#### 完全拘束

すべての寸法が決定されると、✅完全拘束と表示されます。これは：

- すべての辺がロックされている
- または、十分な数の辺と角度がロックされている

ことを意味します。

## 編集モード一覧

| モード | アイコン | 説明 | 操作 |
|--------|---------|------|------|
| **頂点移動** | - | 頂点をドラッグで移動 | 頂点をドラッグ |
| **寸法編集** | 📏 | 辺の長さを調整 | 辺をタップ → 長さ入力 |
| **角度編集** | 📐 | 頂点の角度を調整 | 頂点をタップ → 角度入力 |

## カラーコード

| 色 | 意味 |
|----|------|
| 🔵 青 | 選択されたポリゴン |
| 🔴 赤 | 選択されていないポリゴン |
| 🟡 金色 | ロック済みの辺/頂点 |
| 🟢 緑 | ドラッグ中の頂点 |

## よくある質問（FAQ）

### Q: ポリゴンが開いてしまいました

A: 角度編集モードで「Auto Close」ボタンをタップすると、自動的に閉じることができます。

### Q: ロックされた辺を変更したい

A: 辺を選択し、ModalBottomSheetで「寸法をロック」トグルをタップして、ロックを解除してください。

### Q: 相似変換をやり直したい

A: 現在の実装では、一度相似変換を適用すると、同じポリゴンでやり直すことはできません。ポリゴンを削除して再作成してください。

**制限事項**: この制限は将来のバージョンで改善される可能性があります。Undo/Redo機能やリセット機能の追加を検討しています。

### Q: 複雑な形状（L字型など）を作るには

A: 頂点を順番にタップして、外周をなぞります。内側の角も含めて、すべての角に頂点を配置してください。

### Q: 寸法が正確か確認したい

A: 各辺を選択すると、ModalBottomSheetに現在の長さが表示されます。拘束状態パネルでロック済みの辺と角度の数も確認できます。

## トラブルシューティング

### 頂点が選択できない

- 編集モードが正しいか確認してください
- ポリゴンが選択されているか確認してください
- タップする位置を頂点の近く（約30ピクセル以内）にしてください

### 辺が選択できない

- 寸法編集モードになっているか確認してください
- タップする位置を辺の近く（約30ピクセル以内）にしてください

### ポリゴンが完成しない

- 最低3つの頂点が追加されているか確認してください
- 最初の頂点の近く（約40ピクセル以内）をタップしてください

## ヒントとコツ

1. **正確なトレース**: 背景画像を使用して、実際の間取り図に沿って頂点を配置します。

2. **段階的な調整**: 
   - まず、大まかな形状を作成
   - 次に、頂点の位置を調整
   - 最後に、正確な寸法を設定

3. **重要な寸法から**: 最も確実な辺の長さから設定し、ロックしていきます。

4. **90度の活用**: 部屋の角はほとんど直角なので、90度拘束を積極的に使用します。

5. **保存を忘れずに**: 編集は自動的に保存されますが、定期的に「Save」ボタンでJSONをエクスポートすることをお勧めします。

## まとめ

部屋の形状編集機能を使用することで、正確な寸法を持つ部屋のモデルを作成できます。相似変換、個別調整、ロック機能を組み合わせて、理想的な間取りを再現してください。

ご不明な点がございましたら、お気軽にお問い合わせください。
