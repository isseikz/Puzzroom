# Quick Deploy - Deployment Automation

This directory contains automation tools for deploying Quick Deploy APKs to Android devices.

## üìã Prerequisites

Before using the deployment automation, ensure you have:

1. **Device Token**: A valid Quick Deploy device token (UUID format)
2. **google-services.json**: Firebase configuration file for the quick-deploy-app
   - Required for building the APK
   - Must be placed in `quick-deploy-app/google-services.json`
   - For GitHub Actions: Add as base64-encoded secret `QUICK_DEPLOY_GOOGLE_SERVICES_JSON_BASE64`
3. **Gradle**: Gradle wrapper is included in the repository
4. **Internet Connection**: For API calls to Firebase Cloud Functions

## üìÅ Directory Structure

```
quick-deploy-app/
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ deploy.sh          # Main deployment script
‚îú‚îÄ‚îÄ mcp/
‚îÇ   ‚îú‚îÄ‚îÄ index.js           # MCP server for AI agents
‚îÇ   ‚îú‚îÄ‚îÄ package.json       # Node.js dependencies
‚îÇ   ‚îî‚îÄ‚îÄ README.md          # MCP server documentation
‚îî‚îÄ‚îÄ DEPLOYMENT_AUTOMATION.md  # This file
```

## üöÄ Quick Start

### Option 1: Manual Deployment (Command Line)

```bash
cd quick-deploy-app/scripts
./deploy.sh YOUR_DEVICE_TOKEN
```

Or set environment variable:

```bash
export SECRET_QUICK_DEPLOY_TOKEN="your-device-token-here"
cd quick-deploy-app/scripts
./deploy.sh
```

### Option 2: GitHub Copilot Agent (MCP Server)

1. Install MCP server dependencies:
```bash
cd quick-deploy-app/mcp
npm install
```

2. Configure in GitHub Copilot (add to MCP config):
```json
{
  "mcpServers": {
    "quick-deploy": {
      "command": "node",
      "args": ["/absolute/path/to/quick-deploy-app/mcp/index.js"],
      "env": {
        "SECRET_QUICK_DEPLOY_TOKEN": "your-device-token-here"
      }
    }
  }
}
```

3. Use with Copilot:
```
@workspace Deploy the Quick Deploy APK
```

### Option 3: GitHub Actions (Auto-Deploy on PR)

1. Add required secrets to GitHub repository:
   - Go to repository Settings ‚Üí Secrets and variables ‚Üí Actions
   - Add secret: `SECRET_QUICK_DEPLOY_TOKEN` with your device token value
   - Add secret: `QUICK_DEPLOY_GOOGLE_SERVICES_JSON_BASE64` with base64-encoded google-services.json
     ```bash
     # To create the secret value:
     base64 -w 0 quick-deploy-app/google-services.json
     ```

2. Create or update PR with changes to `quick-deploy-app/`
   - The workflow will automatically deploy when commits are pushed

## üìã Deployment Process

The deployment script performs these 4 steps:

1. **Build APK** - Uses Gradle to build the release APK
2. **Get Upload URL** - Requests a signed URL from Firebase
3. **Upload APK** - Uploads the APK to Firebase Storage
4. **Notify Device** - Sends FCM notification to the device

### Step-by-Step Breakdown

```
[1/4] Building APK...
      ‚Üì
      Runs: ./gradlew :quick-deploy-app:clean :quick-deploy-app:assembleRelease
      Output: quick-deploy-app/build/outputs/apk/release/*.apk
      
[2/4] Getting upload URL...
      ‚Üì
      Requests: POST https://getuploadurl-o45ehp4r5q-uc.a.run.app/upload/{token}/url
      Returns: Signed Firebase Storage URL
      
[3/4] Uploading APK to Firebase Storage...
      ‚Üì
      Uploads: PUT to signed URL with APK binary
      
[4/4] Notifying device...
      ‚Üì
      Notifies: POST https://notifyuploadcomplete-o45ehp4r5q-uc.a.run.app/upload/{token}/notify
      Device receives: FCM push notification
```

## üîß Configuration

### Device Token

Your device token is a UUID generated by the Quick Deploy Android app. You can get it by:

1. Opening the Quick Deploy app on your Android device
2. Copying the device token from the app screen

**Test Device Token**: `7da00b5d-e281-45d2-a4ec-60fd37ddcf6f`

### Environment Variables

- `SECRET_QUICK_DEPLOY_TOKEN` - Your device token (required)

The script checks for device token in this order:
1. Command line argument (`./deploy.sh TOKEN`)
2. Environment variable `SECRET_QUICK_DEPLOY_TOKEN`

### MCP Server Configuration

The MCP server additionally stores tokens in:
- `~/.quick-deploy/device-token.txt` (via `set_device_token` tool)

Priority order for MCP:
1. Parameter to `deploy_apk` tool
2. `SECRET_QUICK_DEPLOY_TOKEN` environment variable
3. Saved file `~/.quick-deploy/device-token.txt`

## üõ†Ô∏è Usage Examples

### Command Line

**Basic usage:**
```bash
./deploy.sh 7da00b5d-e281-45d2-a4ec-60fd37ddcf6f
```

**With environment variable:**
```bash
export SECRET_QUICK_DEPLOY_TOKEN="7da00b5d-e281-45d2-a4ec-60fd37ddcf6f"
./deploy.sh
```

**From repository root:**
```bash
./quick-deploy-app/scripts/deploy.sh 7da00b5d-e281-45d2-a4ec-60fd37ddcf6f
```

### GitHub Copilot Chat

After configuring the MCP server:

```
Deploy the Quick Deploy APK to my device
```

```
Deploy to device 7da00b5d-e281-45d2-a4ec-60fd37ddcf6f
```

```
Save my device token: 7da00b5d-e281-45d2-a4ec-60fd37ddcf6f
```

### GitHub Actions

The workflow automatically triggers when:
- PR is opened with changes to `quick-deploy-app/`
- New commits are pushed to an existing PR
- PR is reopened

**Required:** Secret `SECRET_QUICK_DEPLOY_TOKEN` must be configured in repository settings.

## üìä Exit Codes

The deployment script uses these exit codes:

- `0` - Success
- `1` - Missing device token
- `2` - Build failed
- `3` - Upload failed (URL request or APK upload)
- `4` - Notification failed

## üîç Troubleshooting

### "Device token is required"

**Problem:** No device token provided.

**Solution:**
```bash
# Option 1: Pass as argument
./deploy.sh YOUR_TOKEN

# Option 2: Set environment variable
export SECRET_QUICK_DEPLOY_TOKEN="YOUR_TOKEN"
./deploy.sh
```

### "Build failed"

**Problem:** Gradle build failed.

**Solution:**
1. Check `/tmp/build.log` for details
2. Ensure Java/Gradle is properly configured
3. Try manual build: `./gradlew :quick-deploy-app:assembleRelease`

### "Failed to get upload URL"

**Problem:** Cannot reach Firebase Cloud Function or invalid token.

**Solutions:**
- Verify internet connection
- Check device token is correct
- Verify Firebase functions are deployed
- Try accessing: `https://getuploadurl-o45ehp4r5q-uc.a.run.app/upload/YOUR_TOKEN/url`

### "Upload failed"

**Problem:** Cannot upload APK to Firebase Storage.

**Solutions:**
- Check signed URL is valid (expires after some time)
- Verify APK file exists and is readable
- Check internet connection and firewall settings

### "Notification failed"

**Problem:** Cannot send FCM notification to device.

**Solutions:**
- Verify device token is correct and registered
- Check device has internet connection
- Verify FCM service is working
- Device may have FCM disabled or app uninstalled

## üîê Security

### Device Tokens

- Tokens are long, random UUIDs (36 characters)
- Similar to Google Drive share links - difficult to guess
- Should be treated as secrets (don't commit to public repos)

### Storage

- APKs are stored temporarily in Firebase Storage
- Automatic deletion after 10 minutes
- Only accessible via signed URL with device token

### MCP Server

- Tokens saved locally in `~/.quick-deploy/device-token.txt`
- File permissions: user-only read/write
- Environment variables preferred for CI/CD

## üìñ API Endpoints

### Get Upload URL
```
POST https://getuploadurl-o45ehp4r5q-uc.a.run.app/upload/{deviceToken}/url

Response:
{
  "uploadUrl": "https://storage.googleapis.com/...",
  "notifyUrl": "https://..."
}
```

### Notify Upload Complete
```
POST https://notifyuploadcomplete-o45ehp4r5q-uc.a.run.app/upload/{deviceToken}/notify

Response:
{
  "success": true,
  "message": "Notification sent"
}
```

## üß™ Testing

### Test with Sample Token

```bash
# Use the test device token
./deploy.sh 7da00b5d-e281-45d2-a4ec-60fd37ddcf6f
```

### Test Individual Steps

**Step 1: Build only**
```bash
./gradlew :quick-deploy-app:assembleRelease
```

**Step 2: Get URL only**
```bash
curl "https://getuploadurl-o45ehp4r5q-uc.a.run.app/upload/YOUR_TOKEN/url"
```

**Step 3: Upload manually**
```bash
curl -X PUT -H "Content-Type: application/vnd.android.package-archive" \
  --data-binary "@path/to/app.apk" \
  "SIGNED_URL_FROM_STEP_2"
```

**Step 4: Notify manually**
```bash
curl -X POST "https://notifyuploadcomplete-o45ehp4r5q-uc.a.run.app/upload/YOUR_TOKEN/notify"
```

## üìö Related Documentation

- [`REQUIREMENTS.md`](./REQUIREMENTS.md) - System requirements specification
- [`docs/design/SequenceDiagram.md`](./docs/design/SequenceDiagram.md) - Communication flow
- [`mcp/README.md`](./mcp/README.md) - MCP server documentation
- [`.github/workflows/quick-deploy-auto.yml`](../.github/workflows/quick-deploy-auto.yml) - GitHub Actions workflow

## üéØ Design Goals

This automation was designed with these goals in mind:

1. **Simplicity** - One command to deploy
2. **AI Agent Friendly** - Clear English error messages
3. **CI/CD Ready** - Works in GitHub Actions
4. **Reusable** - Same script for all contexts
5. **Context Efficient** - Minimal token usage for AI agents

## ü§ù Contributing

When modifying the deployment automation:

1. Keep the script simple and focused
2. Provide clear error messages in English
3. Test with the sample device token
4. Update this documentation
5. Ensure GitHub Actions workflow still works

## ‚ö° Performance

Expected timing (with good internet):
- Build: 1-3 minutes (depending on cache)
- Get URL: < 1 second
- Upload: 5-15 seconds (depending on APK size and connection)
- Notify: < 1 second

**Total: ~2-4 minutes** from script start to device notification.

## üìù License

Part of the Puzzroom project - see main repository license.
