# Firebase Functions 実装サマリー

## 概要

quick-deploy-app モジュールに Firebase Cloud Functions の実装を追加しました。このセットアップにより、クライアント（Android/iOS）とサーバー（Firebase Functions）の間でデータ構造を共有できます。

## 実装内容

### 1. Firebase プロジェクト構成

以下のファイルを追加しました：

- **firebase.json**: Firebase の設定ファイル
- **.firebaserc**: Firebase プロジェクト ID の管理
- **firestore.rules**: Firestore のセキュリティルール
- **firestore.indexes.json**: Firestore のインデックス設定

### 2. Cloud Functions の基盤

**ディレクトリ**: `functions/`

Firebase Cloud Functions を実装するための基盤を構築しました：

- Node.js 20 ランタイム環境
- Firebase Admin SDK の初期化
- Kotlin/JS からコンパイルされたコードをインポートできる構造
- 実際の関数は開発要件に応じて実装可能

### 3. 共通データ構造

**場所**: `src/commonMain/kotlin/tokyo/isseikuzumaki/quickdeploy/data/`

以下の共有データモデルを定義しました：

```kotlin
@Serializable
data class Message(
    val text: String,
    val timestamp: Long = 0L
)

@Serializable
data class MessageRequest(val original: String)

@Serializable
data class MessageResponse(val result: String)
```

これらは以下で使用できます：
- Android/iOS アプリ（Kotlin）
- Firebase Functions（JavaScript/TypeScript）
- Kotlin/JS（オプション）

### 4. Kotlin/JS サポート

**場所**: `src/jsMain/kotlin/tokyo/isseikuzumaki/quickdeploy/functions/`

以下の Kotlin/JS バインディングを作成しました：

- **FirebaseFunctions.kt**: Firebase Functions SDK の外部宣言
- **FirebaseAdmin.kt**: Firebase Admin SDK の外部宣言
- **FirebaseFirestore.kt**: Firestore SDK の外部宣言
- **CloudFunctions.kt**: Kotlin/JS での関数実装例

### 5. Gradle ビルド設定

`build.gradle.kts` に JavaScript ターゲットを追加：

```kotlin
js(IR) {
    nodejs()
    binaries.executable()
}
```

これにより、Kotlin コードを JavaScript にコンパイルできます。

## アーキテクチャ

### データフロー

```
[Android/iOS クライアント]
         ↓
    Kotlin データモデル (@Serializable)
         ↓
    JSON シリアライゼーション
         ↓
    HTTP / Firestore
         ↓
[Firebase Functions]
         ↓
    JavaScript でデータ処理
         ↓
    JSON レスポンス
         ↓
[Android/iOS クライアント]
```

### 利点

1. **型安全性**: Kotlin の型システムを活用
2. **コード共有**: データモデルを一度だけ定義
3. **一貫性**: クライアントとサーバーで同じデータ構造
4. **保守性**: 変更が容易で、バグが少ない

## セットアップ手順

### 必須要件

- Node.js 20 以上（✓ インストール済み）
- npm 10 以上（✓ インストール済み）
- Firebase CLI（オプション）

### 初期設定

1. **Firebase プロジェクト ID の設定**

   `.firebaserc` を編集：
   ```json
   {
     "projects": {
       "default": "your-actual-project-id"
     }
   }
   ```

2. **依存関係のインストール**

   ```bash
   cd functions
   npm install
   ```

3. **ローカルテスト**

   ```bash
   npm run serve
   ```

   エミュレーターが起動: http://localhost:4000

4. **デプロイ**

   ```bash
   npm run deploy
   ```

## 使用例

### クライアント側（Kotlin）

```kotlin
import tokyo.isseikuzumaki.quickdeploy.data.Message
import kotlinx.serialization.json.Json

val message = Message(
    text = "こんにちは",
    timestamp = System.currentTimeMillis()
)

// JSON にシリアライズ
val json = Json.encodeToString(message)

// Firestore に保存または HTTP で送信
```

### サーバー側（JavaScript）

```javascript
export const processMessage = onRequest(async (req, res) => {
  // Kotlin と同じデータ構造
  const text = req.body.text;
  const timestamp = req.body.timestamp;
  
  // 処理
  const result = text.toUpperCase();
  
  res.json({ result: result });
});
```

## ファイル構成

```
quick-deploy-app/
├── firebase.json                 # Firebase 設定
├── .firebaserc                   # プロジェクト ID
├── firestore.rules               # セキュリティルール
├── firestore.indexes.json        # Firestore インデックス
├── FIREBASE_SETUP.md             # 詳細セットアップガイド（英語）
├── QUICK_REFERENCE.md            # クイックリファレンス（英語）
├── verify-setup.sh               # セットアップ検証スクリプト
├── functions/                    # Cloud Functions
│   ├── package.json             # Node.js 依存関係
│   ├── index.js                 # 関数エントリポイント
│   └── .eslintrc.json           # ESLint 設定
├── src/
│   ├── commonMain/kotlin/       # 共有コード
│   │   └── .../data/
│   │       └── Message.kt       # 共有データモデル
│   └── jsMain/kotlin/           # Kotlin/JS コード
│       └── .../functions/
│           └── CloudFunctions.kt # Kotlin/JS 実装
└── build.gradle.kts              # Gradle ビルド（JS ターゲット追加）
```

## ドキュメント

1. **FIREBASE_SETUP.md**: 完全なセットアップガイド
   - 前提条件
   - セットアップ手順
   - ローカルテスト
   - デプロイ方法
   - トラブルシューティング

2. **QUICK_REFERENCE.md**: クイックリファレンス
   - 一般的なパターン
   - コード例
   - ベストプラクティス

3. **verify-setup.sh**: セットアップ検証スクリプト
   - 環境チェック
   - ファイル検証
   - 依存関係確認

## 実装方針の選択

この実装では、以下の2つのアプローチを選択できます：

### オプション1: JavaScript/TypeScript（現在の実装）
- ✅ 標準的な Firebase ツールチェーン
- ✅ 簡単なセットアップ
- ✅ 豊富なドキュメント
- ⚠️ データ構造を手動で同期

### オプション2: Kotlin/JS（高度な使用）
- ✅ 完全な型安全性
- ✅ コードの完全共有
- ✅ Kotlin エコシステム
- ⚠️ 追加のビルドステップが必要

**推奨**: まず JavaScript で開始し、必要に応じて Kotlin/JS に移行

## 次のステップ

1. `.firebaserc` に実際の Firebase プロジェクト ID を設定
2. `cd functions && npm install` を実行
3. `npm run serve` でローカルテスト
4. `npm run deploy` でデプロイ
5. Firestore ルールを本番環境用に更新
6. 追加の関数を実装

## セキュリティに関する注意

- `firestore.rules` は開発用の設定です
- 本番環境では適切な認証・認可ルールを設定してください
- 環境変数を使用して機密情報を管理してください

## 検証

セットアップを検証するには：

```bash
cd quick-deploy-app
./verify-setup.sh
```

すべてのチェックが通れば、セットアップは完了です！

## 参考資料

- [Firebase Functions ドキュメント（日本語）](https://firebase.google.com/docs/functions?hl=ja)
- [Kotlin/JS ドキュメント](https://kotlinlang.org/docs/js-overview.html)
- [kotlinx.serialization](https://github.com/Kotlin/kotlinx.serialization)

---

**実装者**: GitHub Copilot
**実装日**: 2025-11-01
**ステータス**: ✅ 完了
