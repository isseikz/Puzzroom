name: Mobile Vibe Terminal - Upload to Google Play

on:
  release:
    types: [prereleased]

jobs:
  upload-to-play-store:
    # Only run for Mobile Vibe Terminal releases (v*.*.* tags)
    if: startsWith(github.event.release.tag_name, 'v')
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.release.tag_name }}

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Extract version from tag
      id: version
      run: |
        TAG_NAME="${{ github.event.release.tag_name }}"
        VERSION_NAME="${TAG_NAME#v}"
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION_NAME"

    - name: Decode release keystore
      run: |
        echo "${{ secrets.MVT_RELEASE_KEYSTORE }}" | base64 -d > release.keystore

    - name: Create keystore.properties
      run: |
        cat > keystore.properties << EOF
        storeFile=../release.keystore
        storePassword=${{ secrets.MVT_KEYSTORE_PASSWORD }}
        keyAlias=${{ secrets.MVT_KEY_ALIAS }}
        keyPassword=${{ secrets.MVT_KEY_PASSWORD }}
        EOF

    - name: Build Release AAB
      run: ./gradlew :mobile-vibe-terminal:bundleRelease --no-daemon

    - name: Sign AAB
      env:
        KEYSTORE_PASSWORD: ${{ secrets.MVT_KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.MVT_KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.MVT_KEY_PASSWORD }}
      run: |
        jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
          -keystore release.keystore \
          -storepass "$KEYSTORE_PASSWORD" \
          -keypass "$KEY_PASSWORD" \
          ./mobile-vibe-terminal/build/outputs/bundle/release/mobile-vibe-terminal-release.aab \
          "$KEY_ALIAS"

    - name: Verify AAB signature
      run: |
        jarsigner -verify ./mobile-vibe-terminal/build/outputs/bundle/release/mobile-vibe-terminal-release.aab

    - name: Upload AAB to Google Play (Internal Testing)
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.MVT_GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        packageName: tokyo.isseikuzumaki.vibeterminal
        releaseFiles: ./mobile-vibe-terminal/build/outputs/bundle/release/mobile-vibe-terminal-release.aab
        track: internal
        status: completed
        releaseName: ${{ steps.version.outputs.version_name }}

    - name: Output summary
      run: |
        echo "## Google Play Upload Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Version | ${{ steps.version.outputs.version_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Package | tokyo.isseikuzumaki.vibeterminal |" >> $GITHUB_STEP_SUMMARY
        echo "| Track | internal |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "AAB has been uploaded to Google Play Console (Internal Testing track)." >> $GITHUB_STEP_SUMMARY
